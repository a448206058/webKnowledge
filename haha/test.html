<html lang="zh-cn" style="height: 100%">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>腾讯极客技术挑战赛</title>

    <link rel="stylesheet" href="./static/css/bootstrap.min.css">

    <link href="./static/css/fileinput.min.css" rel="stylesheet">

    <script src="./static/js/jquery.min.js"></script>

    <script src="./static/js/popper.min.js"></script>

    <script src="./static/js/bootstrap.min.js"></script>

    <script src="./static/js/fileinput.min.js"></script>

    <script src="./static/js/zh.min.js"></script>

    <link rel="stylesheet" type="text/css" href="./static/css/markdown.css">


    <script src="./static/js/A274075A.js"></script>
</head>

<body style="height: 100%">

<div class="container" style="min-height: 100%">


    <div class="border-bottom" style="padding-bottom: 15px;">
        <h1 style="margin-bottom: 30px; display: none">码上种树</h1>

        <img src="/media/tree-banner.png">


        <div class="badge badge-success text-wrap"> 进行中：

            2021年3月12日 17:00 至 2021年3月17日 17:00
        </div>
    </div>

    <div class="row py-3">
        <div class="col" id="main">

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel"
                     aria-labelledby="description-tab">

                    <button id="plant_btn" type="button" class="btn btn-success"
                            onclick="tree('00001019751B08D11324FE0AD0889EC3')" style="
							width: 300px;
							padding-top: 20px;
							padding-bottom: 20px;
							font-size: x-large;
							display: block;
							margin: 20px 0 10px 0;">点我继续种树
                    </button>

                    <p id="plant_count" style="width: 300px; margin: 0 0 30px 0; text-align: center; color: #aaa;">
                        您已累计种下 11 棵树</p>
                </div>

            </div>


        </div>
    </div>
</div>


<script>
    const assets = "http://159.75.70.9:8080";
    const cgi = "http://159.75.70.9:8081";

    var button = $("#plant_btn");
    var count = $('#plant_count');

    function show(text) {
        button.prop('disabled', true);
        button.text(text);
    }

    function done() {
        button.prop('disabled', false);
        button.text('点我继续种树');
    }

    function counter(n) {
        count.text('您已累计种下 ' + n + ' 棵树');
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function run(name) {
        const url = `${assets}/${name}.js`;

        return new Promise((resolve, reject) => {
            function resolving() {
                if (window[name]) {
                    return resolve(window[name]);
                } else {
                    return reject();
                }
            }

            if (document.querySelector(`head > script[ src = "${url}" ]`) !== null) {
                return resolving();
            }

            const script = document.createElement("script");
            script.src = url;
            script.onload = resolving;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    async function tree(token) {

        try {
            show("准备中");
            // $.ajax ({
            //     type: "get",
            //     url: `${cgi}/pull?u=${token}`,
            //     dataType: 'jsonp',
            //     success: function (data) {
            //         console.log(222)
            //         alert("身高: " + data.height + ", 体重: " + data.weight);
            //     },
            //     error: function(error){
            //         console.log(3322)
            //         console.log(error)
            //     }
            // });
            // console.log(`${cgi}/pull?u=${token}`)
            // $.ajax({
            //     url:`${cgi}/pull?u=${token}`,
            //     // data:你的数据,
            //     dataType:'jsonp',  //【这里要小心啊，不要用jsonp，一定是json】
            //     jsonpCallback:"success_jsonpCallback",
            //     type:'get',
            //     crossDomain: true,  //【这个很重要，一定要加】
            //     success:function(result){
            //         console.log(result);
            //     },
            //     error:function(result){
            //         console.log(result);
            //     }
            // });
            // return
            // const pull = await (await fetch(`${cgi}/pull?u=${token}`)).json();
            // 创建script
            var script = document.createElement('script');
// 设置回调函数
            function getData(data){
                // 数据请求回来时触发
                console.log(data);
            }
// 设置script的src属性，设置请求地址
            script.src = `${cgi}/pull?u=${token}`;
// 让script生效
            document.body.appendChild(script);

            const pull = {
                "c": "A274075A",
                "a": [
                    78141
                ],
                "t": "0000101900000016B1A246C979F0ECB0"
            };
            await sleep(500);

            if (!pull.c || !pull.t) {
                throw pull;
            }

            show("种植中");
            const val = await (await run(pull.c))(pull);

            show("浇水中");
            const push = await (await fetch(`${cgi}/push?t=${pull.t}&a=${val}`)).json();
            await sleep(500);

            if (!push.success) {
                throw push;
            }

            show("成功种下一棵树");
            counter(push.score);
            await sleep(2000);
        } catch (e) {
            alert(typeof e == "object" && e.error ? e.error : "发生了一些错误，请稍后重试。");
        }

        done();
    }

</script>

</body>
</html>
