[](https://cloud.tencent.com/developer/article/1410405)

[](https://juejin.cn/post/6844903684900388871)

[](https://juejin.cn/post/6844903842635579405)

### XSS攻击
XSS（Cross-Site Scripting，跨站脚本攻击）是一种代码注入攻击。

根据攻击的来源，XSS攻击可以分为存储型（持久性）、反射性（非持久型）和DOM型三种

* 反射型XSS
当用户点击一个恶意链接，或者提交一个表单，或者进入一个恶意网站时，注入脚本进入被攻击者的网站。Web服务器将注入脚本，比如一个错误信息，搜索结果等，未进行过滤直接返回到用户的浏览器上。

攻击步骤：
1. 攻击者构造出特殊的URL，其中包含恶意代码
2. 用户打开带有恶意代码的URL时，网站服务端将恶意代码从URL中取出，拼接在HTML中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

防御：
对字符串进行编码：对url的查询参数进行转义后再输出到页面。
```JavaScript
app.get('/welcome', function(req, res){
    // 对查询参数进行编码，避免反射型XSS攻击
    res.send(`${encodeURIComponent(req.query.type)}`);
})
```

* DOM型XSS
DOM型XSS攻击，实际上就是前端JavaScript代码不够严谨，把不可信的内容插入到了页面。在使用.innerHTML、outerHTML、appendChild、document.write()等API时要特别小心，不要把不可信的数据作为HTML插到页面上，尽量使用.innerText、.textContent、.setAttribute()等。

攻击步骤：
1. 攻击者构造出特殊数据，其中包含恶意代码
2. 用户浏览器执行了恶意代码
3. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

防御：
防范DOM型XSS攻击的核心就是对输入内容进行转义（DOM中的内联事件监听器和链接跳转都能把字符串作为代码运行，需要对其内容进行检查）。
1. 对于url链接，直接使用encodeURIComponent转义
2. 非url
```JavaScript
function encodeHtml(str) {
    return str.replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
}
```

* 存储型XSS
恶意脚本永久存储在目标服务器上。当浏览器请求数据时，脚本从服务器传回并执行，影响范围比反射型和DOM型XSS更大。存储型XSS攻击的原因仍然是没有做好数据过滤：前端提交数据至服务端时，没有做好过滤；服务端在接受到数据时，在存储之前，没有做过滤；前端从服务端请求到数据，没有过滤输出。

攻击步骤：
1. 攻击者将恶意代码提交到目标网站的数据库中。
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在HTML中返回给浏览器
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

防御：
1. 前端数据传递给服务器之前，先转义/过滤
2. 服务器接收到数据，在存储到数据库之前，进行转义/过滤
3. 前端接收到服务器传递过来的数据，在展示到页面前，先进行转义/过滤

4. Content Security Policy
在服务端使用HTTP的Content-Security-Policy头部来指定策略，或者在前端设置meta标签
```JavaScript
// 服务端
Content-Security-Policy: default-src 'self'

// 客户端
<meta http-equiv="Content-Security-Policy" content="form-action 'self';">
```
严格的CSP在XSS的防范中可以起到以下的作用：
禁止加载外域代码，防止复杂的攻击逻辑
禁止外域提交，网站被攻击后，用户的数据不会泄露到外域
禁止内联脚本执行
禁止未授权的脚本执行
合理使用上报可以及时发现XSS，利于尽快修复问题

5. 输入内容长度控制
6. 输入内容限制（可以限定不能包含特殊字符或者仅能输入数字等）
7. HTTP-only Cookie:禁止JavaScript读取敏感Cookie
8. 验证码：防止脚本冒充用户提交危险操作

### CSRF
CSRF（Cross-site request forgery）跨站请求伪造：攻击者诱导受害者进入第三方网站，在第三方网站中，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到冒充用户对被攻击网站执行某项操作的目的。
